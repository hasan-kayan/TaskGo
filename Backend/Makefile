# ------------------------------------------------------------
# TaskGo â€“ Developer Convenience Makefile  ğŸ› ï¸ğŸš€
# ------------------------------------------------------------
SHELL := /usr/bin/env bash
APP   ?= taskgo-backend
PORT  ?= 8080

# Colours (ANSI)
CYAN  := \033[36m
GREEN := \033[32m
YELL  := \033[33m
RESET := \033[0m

.PHONY: help deps docs dev lint test coverage docker run clean

# -----------------------------------------------------------------
# ğŸ†˜  help â€“ pretty-prints available targets
# -----------------------------------------------------------------
help:              ## Show this help ğŸŒˆ
	@echo -e "$(YELL)Available targets$(RESET)\n"
	@grep -E '^[a-zA-Z_-]+:.*?## ' $(MAKEFILE_LIST) \
		| awk 'BEGIN {FS=":.*?## "}; {printf "$(CYAN)%-12s$(RESET) %s\n", $$1, $$2}'

# -----------------------------------------------------------------
# âš™ï¸  deps â€“ module tidy + install CLI tooling
# -----------------------------------------------------------------
deps:              ## Install Go deps & CLI tools (swag, air, golangci-lint) ğŸ›’
	@echo -e "$(GREEN)â€¢ Tidying go.mod$(RESET)"
	go mod tidy

	@echo -e "$(GREEN)â€¢ Ensuring swag is installed$(RESET)"
	@if ! command -v swag >/dev/null; then \
		echo "  â†³ fetching swagâ€¦"; \
		go install github.com/swaggo/swag/cmd/swag@latest; \
	else echo "  â†³ swag already present âœ”ï¸"; fi

	@echo -e "$(GREEN)â€¢ Ensuring air is installed$(RESET)"
	@if ! command -v air >/dev/null; then \
		echo "  â†³ fetching airâ€¦"; \
		go install github.com/air-verse/air@latest; \
	else echo "  â†³ air already present âœ”ï¸"; fi

	@echo -e "$(GREEN)â€¢ Ensuring golangci-lint is installed$(RESET)"
	@if ! command -v golangci-lint >/dev/null; then \
		echo "  â†³ fetching golangci-lintâ€¦ (this may take a sec)"; \
		curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh \
			| sh -s -- -b $$(go env GOPATH)/bin v1.55.2; \
	else echo "  â†³ golangci-lint already present âœ”ï¸"; fi

	@echo -e "$(GREEN)ğŸ‰  All tools ready!$(RESET)"

# -----------------------------------------------------------------
# ğŸ“‘  docs â€“ regenerate Swagger files
# -----------------------------------------------------------------
docs:             ## Re-generate Swagger (docs/*) ğŸ–‹ï¸
	@echo -e "$(GREEN)â€¢ Re-building Swagger docs$(RESET)"
	swag init --parseDependency --parseInternal --dir ./ --output ./docs
	@echo -e "$(GREEN)âœ“ Swagger docs updated!$(RESET)"

# -----------------------------------------------------------------
# ğŸƒ  dev â€“ live-reload API with air
# -----------------------------------------------------------------
dev:              ## Start API w/ hot reload (falls back to go run) ğŸ”¥
	@echo -e "$(GREEN)â€¢ Launching development server$(RESET)"
	@command -v air >/dev/null && air -c .air.toml || go run .

# -----------------------------------------------------------------
# ğŸ”  lint â€“ vet + golangci-lint
# -----------------------------------------------------------------
lint:             ## Static analysis & linters ğŸ”
	@echo -e "$(GREEN)â€¢ Running go vet$(RESET)"
	go vet ./...
	@echo -e "$(GREEN)â€¢ Running golangci-lint$(RESET)"
	@command -v golangci-lint >/dev/null && golangci-lint run || \
		echo -e "$(YELL)âš ï¸  golangci-lint not installed â€“ run 'make deps'$(RESET)"

# -----------------------------------------------------------------
# ğŸ§ª  test â€“ race detector & coverage
# -----------------------------------------------------------------
test:             ## Run all unit/integration tests ğŸ§ª
	@echo -e "$(GREEN)â€¢ Running tests (race-detector + coverage)$(RESET)"
	go test -v -race -coverpkg=./... -coverprofile=coverage.out ./...

coverage: test    ## Show coverage summary ğŸ“ˆ
	@echo -e "$(GREEN)â€¢ Coverage report$(RESET)"
	go tool cover -func=coverage.out
	@echo -e "$(CYAN)ğŸ’¡ Tip: 'go tool cover -html=coverage.out' for HTML view$(RESET)"

# -----------------------------------------------------------------
# ğŸ³  docker â€“ multi-stage build & run
# -----------------------------------------------------------------
docker:           ## Build docker image ğŸ³
	@echo -e "$(GREEN)â€¢ Building Docker image '$(APP):latest'$(RESET)"
	docker build -t $(APP):latest .

run: docker       ## Run container on host:$(PORT) ğŸš¢
	@echo -e "$(GREEN)â€¢ Starting container$(RESET)"
	docker run -it --rm -p $(PORT):8080 --name $(APP) $(APP):latest

# -----------------------------------------------------------------
# ğŸ§¹  clean â€“ remove generated artefacts
# -----------------------------------------------------------------
clean:            ## Delete coverage & Swagger artefacts ğŸ§¹
	@echo -e "$(GREEN)â€¢ Cleaning build artefacts$(RESET)"
	rm -f coverage.out
	rm -rf docs/swagger.* docs/docs.go
	@echo -e "$(GREEN)âœ“ Cleaned$(RESET)"
